# 実装タスク

- [x] 1. データ構造の基盤整備とメタデータ保存機能の実装
- [x] 1.1 画像生成時のメタデータ構造定義と型システムの構築
  - アーカイブアイテムの型定義を作成し、必須フィールドを明確化する
  - メタデータJSONの構造を定義し、TypeScript型として実装する
  - 型ガード関数を実装し、メタデータの検証ロジックを構築する
  - 日付ベースのプレフィックス構造を定義し、ファイル名パターンを確立する
  - _Requirements: 1.1, 1.3, 1.4, 3.1, 3.2, 3.5_

- [x] 1.2 画像とメタデータの同時保存機能の実装
  - 日付ベースのプレフィックス構造でR2に保存する機能を実装する
  - 画像ファイルとメタデータJSONをアトミックに保存する機能を構築する
  - メタデータ保存が失敗した場合のロールバック機能を実装する
  - 画像とメタデータのファイル名対応関係を保証する機能を実装する
  - _Requirements: 1.1, 1.2, 1.5, 1.6, 1.7, 9.1, 9.2_

- [x] 1.3 既存の画像生成フローへのメタデータ保存の統合
  - 画像生成サービスに新しい保存機能を統合する
  - 生成パラメータ（MC値、視覚パラメータ、シード値）をメタデータとして保存する
  - プロンプトとネガティブプロンプトをメタデータに含める
  - 画像の公開URLとファイルサイズをメタデータに記録する
  - _Requirements: 1.5, 1.8, 9.1, 9.2_

- [x] 2. R2ストレージからのアーカイブデータ取得機能の実装
- [x] 2.1 R2リストAPIによる画像一覧取得機能の構築
  - R2の`list`メソッドを使用して画像オブジェクトを取得する機能を実装する
  - カーソルベースのページネーション機能を実装する
  - 取得件数の制限機能（最大100件）を実装する
  - 画像ファイル（`.webp`）のみをフィルタリングする機能を実装する
  - _Requirements: 2.1, 2.2, 2.3, 2.8, 2.10_

- [x] 2.2 日付ベースのフィルタリング機能の実装
  - 日付文字列（`YYYY-MM-DD`）を解析し、プレフィックスを生成する機能を実装する
  - 開始日と終了日による範囲フィルタリング機能を実装する
  - 複数の日付プレフィックスに対する並行クエリ機能を実装する
  - 日付範囲の結果をマージし、時系列順にソートする機能を実装する
  - _Requirements: 2.4, 2.5, 2.6, 2.11, 2.12, 8.3, 8.5_

- [x] 2.3 メタデータの読み込みと検証機能の実装
  - 各画像に対応するメタデータJSONを並行取得する機能を実装する
  - メタデータの構造を検証し、必須フィールドの存在を確認する機能を実装する
  - メタデータが存在しない画像をスキップする機能を実装する
  - エラーログを記録し、スキップされたアイテムを追跡する機能を実装する
  - _Requirements: 2.8, 2.9, 3.2, 3.3, 9.3, 9.5, 9.6_

- [x] 2.4 アーカイブアイテムのレスポンス構築機能の実装
  - アーカイブアイテムの配列を`timestamp`降順でソートする機能を実装する
  - ページネーション情報（`cursor`、`hasMore`）を含むレスポンスを構築する機能を実装する
  - 公開URLを生成し、アーカイブアイテムに含める機能を実装する
  - _Requirements: 2.7, 2.10, 3.4_

- [x] 3. アーカイブAPIエンドポイントの実装
- [x] 3.1 Next.js API Routeの作成とクエリパラメータ処理
  - `/api/archive`エンドポイントを作成し、Edge Runtimeで実行する
  - クエリパラメータ（`cursor`、`limit`、`startDate`、`endDate`）を解析する機能を実装する
  - パラメータのバリデーション機能を実装する（`limit`の範囲、日付形式の検証）
  - 無効なパラメータに対するエラーレスポンスを実装する
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5_

- [x] 3.2 アーカイブサービスとの統合とエラーハンドリング
  - アーカイブサービスを呼び出し、結果をHTTPレスポンスに変換する機能を実装する
  - エラー発生時の適切なHTTPステータスコードとメッセージを返す機能を実装する
  - R2操作の失敗やメタデータの解析エラーをハンドリングする機能を実装する
  - _Requirements: 2.1, 2.7, 10.2_

- [x] 3.3 キャッシュ戦略とパフォーマンス最適化
  - React Queryのキャッシュキー設計を実装する
  - 同一クエリパラメータのリクエストをキャッシュから返す機能を実装する
  - 並行メタデータ取得のエラー耐性を確保する（`Promise.allSettled`）
  - _Requirements: 10.1, 10.2_

- [x] 4. アーカイブページのフロントエンド実装
- [x] 4.1 Next.jsページルートの作成とSSR実装
  - `/archive`ページルート（`src/app/archive/page.tsx`）を作成する
  - 初期ページのデータをSSRで取得する機能を実装する
  - URLクエリパラメータ（`cursor`、`startDate`、`endDate`）を管理する機能を実装する
  - _Requirements: 4.1, 4.2, 4.3_

- [x] 4.2 React Queryによるデータ取得とページネーション管理
  - React Queryを使用してアーカイブAPIからデータを取得する機能を実装する
  - ページネーション状態を管理し、`cursor`に基づいて追加データを取得する機能を実装する
  - ローディング状態とエラー状態を管理する機能を実装する
  - _Requirements: 4.3, 7.1, 7.3, 7.4, 10.1_

- [x] 4.3 エラー表示とリトライ機能の実装
  - エラーメッセージを表示する機能を実装する
  - リトライボタンを提供し、再度データ取得を試みる機能を実装する
  - _Requirements: 4.4, 7.5_

- [x] 5. ページネーションUIコンポーネントの実装
- [x] 5.1 ページネーションコントロールの作成
  - 前へ/次へボタンを含むページネーションコントロールを実装する
  - 現在のページ範囲を表示する機能を実装する（例: "1-50 of 1,234"）
  - ボタンの有効/無効状態を管理する機能を実装する
  - 時間フィルタUIの上に配置する（画面下部から適切な距離を確保）
  - _Requirements: 7.1, 7.2_

- [x] 5.2 URLクエリパラメータとの連動
  - ページネーション操作時にURLクエリパラメータを更新する機能を実装する
  - ブラウザの戻る/進むボタンで動作する機能を実装する
  - _Requirements: 7.3_

- [x] 5.3 スケルトンローダーの実装
  - 画像が表示される部分にskeleton loaderをspotで表示する機能を実装する
  - 画像の読み込み中に額縁と同じサイズ・形状のskeleton loaderを表示する
  - 画像読み込み完了時にskeleton loaderを非表示にする
  - _Requirements: 7.4_

- [x] 6. Three.jsアーカイブシーンの基盤実装
- [x] 6.1 3D Canvasの初期化と基本設定
  - React Three Fiberの`Canvas`を使用して3D空間を構築する
  - 既存の`GalleryScene`と同様の照明と背景スタイルを適用する
  - `frameloop="demand"`で省電力化を実現する
  - _Requirements: 5.1_

- [x] 6.2 レスポンシブなグリッドレイアウトの実装
  - デスクトップ（5列×10行）とモバイル（2列×25行）のグリッドレイアウトを実装する
  - 画面サイズに応じてグリッド設定を切り替える機能を実装する
  - 各画像の3D空間内での位置を計算する機能を実装する
  - _Requirements: 5.2_

- [x] 6.3 カメラとスクロールの連動機能の実装
  - HTMLのスクロールイベントを監視し、カメラのZ位置を更新する機能を実装する
  - スクロール位置からカメラの目標位置を計算する機能を実装する
  - `lerp`を使用してカメラ移動をスムーズに補間する機能を実装する
  - 仮想スクロール高さを計算し、HTMLの`scrollHeight`を設定する機能を実装する
  - _Requirements: 5.4_

- [x] 7. 仮想化機能の実装
- [x] 7.1 ビューポート計算と可視範囲の判定
  - カメラ位置とビューポートから可視範囲を計算する機能を実装する
  - バッファ領域（±3行）を考慮した範囲を計算する機能を実装する
  - 毎フレーム可視範囲を更新する機能を実装する
  - _Requirements: 6.1, 6.2, 6.5_

- [x] 7.2 動的な画像の読み込みとメモリ管理
  - ビューポート内の画像のみをThree.jsシーンに追加する機能を実装する
  - 画面外の画像をメモリから削除する機能を実装する
  - テクスチャを`dispose()`で解放する機能を実装する
  - _Requirements: 6.1, 6.4_

- [x] 7.3 スケルトンローダーと遅延読み込みの実装
  - 画像の読み込み中にskeleton loaderを画像表示部分にspotで表示する機能を実装する
  - 額縁と同じサイズ・形状のskeleton loaderを3D空間内の画像位置に配置する
  - `Suspense`を使用して遅延読み込みを実現する機能を実装する
  - 画像読み込み完了時にskeleton loaderを非表示にする
  - _Requirements: 6.3_

- [x] 8. 画像コンポーネントとインタラクションの実装
- [x] 8.1 アーカイブ用の額縁付き画像コンポーネントの作成
  - 既存の`FramedPainting`をベースに、アーカイブ用のコンポーネントを作成する
  - 3D空間内での位置を指定できる機能を実装する
  - テクスチャの読み込みと管理を実装する
  - アンマウント時にテクスチャを解放する機能を実装する
  - _Requirements: 5.2_

- [x] 8.2 画像クリック時のzoom-in表示機能の実装
  - 画像クリック/タッチイベントを検知する機能を実装する
  - クリックされた画像にzoom-inアニメーションを適用する機能を実装する
  - 他の絵画をinvisible（非表示）にする機能を実装する
  - クリックされた画像のメタデータを取得する機能を実装する
  - _Requirements: 5.5_

- [x] 9. zoom-in詳細表示の実装
- [x] 9.1 zoom-in表示の基本構造とレイアウトの実装
  - クリックされた絵画をzoom-inして表示する機能を実装する
  - 左側に絵画、右側に生成時のメタデータを表示するレイアウトを実装する
  - 他の絵画をinvisible（非表示）にする機能を実装する
  - デスクトップとモバイルでレイアウトを切り替える機能を実装する
  - _Requirements: 8.1_

- [x] 9.2 zoom-inアニメーションとカメラ制御の実装
  - クリックされた絵画にzoom-inアニメーションを適用する機能を実装する
  - カメラをクリックされた絵画の位置に移動する機能を実装する
  - スムーズなアニメーション遷移を実装する（`lerp`を使用）
  - _Requirements: 8.1_

- [x] 9.3 メタデータの詳細表示機能の実装
  - 右側に生成時のメタデータを表示する機能を実装する
  - 基本情報（生成時刻、ファイルサイズ、シード値、パラメータハッシュ）を表示する機能を実装する
  - 各トークンのMarket Cap値を表示する機能を実装する
  - 視覚パラメータを表示する機能を実装する
  - プロンプトとネガティブプロンプトを表示する機能を実装する
  - _Requirements: 8.1, 8.7_

- [x] 9.4 zoom-in表示の操作機能の実装
  - 閉じるボタンを実装する（zoom-outして元の表示に戻る）
  - ESCキーでzoom-outする機能を実装する
  - 背景クリックでzoom-outする機能を実装する
  - zoom-in表示中のスクロールを無効化する機能を実装する
  - _Requirements: 8.1_

- [x] 10. 日付フィルタリングUIの実装
- [x] 10.1 時間フィルタ/ソートUIの基本構造とレイアウトの実装
  - minimalなliquid glassスタイルのUIコンポーネントを作成する
  - 画面下部に固定配置する機能を実装する（`position: fixed, bottom: 0`）
  - 開始日と終了日を選択できる日付範囲ピッカーを実装する
  - HTML5の`<input type="date">`を使用する
  - liquid glassエフェクト（`backdrop-filter: blur`, 半透明背景）を適用する
  - モバイルとデスクトップでレイアウトを調整する機能を実装する
  - _Requirements: 8.2, 8.8_

- [x] 10.2 日付フィルタの適用とURL連動
  - 日付選択時に`startDate`と`endDate`クエリパラメータを更新する機能を実装する
  - URLクエリパラメータに基づいてフィルタを適用する機能を実装する
  - ブラウザの戻る/進むボタンで動作する機能を実装する
  - _Requirements: 8.2, 8.6_

- [x] 10.3 フィルタ適用時のUI更新とページネーションとの位置調整
  - フィルタ適用時にページネーションをリセットする機能を実装する
  - フィルタ適用時にスクロール位置をリセットする機能を実装する
  - 時間フィルタUIとページネーションコントロールの位置関係を調整する（時間フィルタUIを画面下部に固定、ページネーションはその上に配置）
  - _Requirements: 8.3_

- [x] 11. パフォーマンス最適化とテスト
- [x] 11.1 キャッシュ戦略の実装と検証
  - React Queryのキャッシュ設定を最適化する
  - 画像URLのCDNキャッシュを活用する機能を実装する
  - 次のページの画像をバックグラウンドでプリロードする機能を実装する
  - _Requirements: 10.1, 10.3, 10.5_

- [x] 11.2 パフォーマンステストと最適化
  - R2の`list`操作のパフォーマンスを測定し、最適化する
  - 仮想化のメモリ使用量を測定し、最適化する
  - スクロール時のフレームレートを測定し、最適化する
  - _Requirements: 10.6_

- [x] 11.3 ユニットテストの実装
  - アーカイブサービスのロジックをテストする
  - 型ガード関数をテストする
  - 日付プレフィックス生成ロジックをテストする
  - ソートとページネーションロジックをテストする
  - _Requirements: 全要件の品質保証_

- [x] 11.4 統合テストの実装
  - アーカイブAPIとサービス層の統合をテストする
  - 画像生成とメタデータ保存の統合をテストする
  - ページネーションとデータ取得の統合をテストする
  - _Requirements: 全要件の統合検証_

- [x] 11.5 E2Eテストの実装
  - アーカイブページの表示と操作をテストする
  - ページネーション操作をテストする
  - 日付フィルタの適用をテストする
  - zoom-in詳細表示の表示と操作をテストする
  - モバイルとデスクトップのレスポンシブ動作をテストする
  - _Requirements: 全要件のエンドツーエンド検証_

- [x] 12. 統合とデプロイ準備
- [x] 12.1 既存システムとの統合
  - 既存の`TopBar`コンポーネントとの統合を実装する
  - 既存の`GalleryRoom`と`Lights`コンポーネントを再利用する
  - 既存のエラーハンドリングパターンと統合する
  - _Requirements: 全要件の既存システムとの整合性_

- [x] 12.2 ドキュメントとコメントの追加
  - 主要な関数とコンポーネントにJSDocコメントを追加する
  - 複雑なロジックに説明コメントを追加する
  - 型定義にドキュメントコメントを追加する
  - _Requirements: 保守性の向上_

- [x] 12.3 最終検証とデプロイ準備
  - 全ての要件が満たされていることを確認する
  - パフォーマンス目標が達成されていることを確認する
  - セキュリティ考慮事項が実装されていることを確認する
  - デプロイ前のチェックリストを完了する
  - _Requirements: 全要件の最終検証_
