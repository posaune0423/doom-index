# Implementation Plan

- [x] 1. インフラストラクチャと設定の準備
- [x] 1.1 Cloudflare KV Namespaceの作成と設定
  - Cloudflare KV Namespaceを作成し、VIEWER_KVバインディングを設定する
  - wrangler.tomlにKV Namespaceバインディングを追加する
  - 開発環境と本番環境の両方でKV Namespaceが利用可能であることを確認する
  - _Requirements: 5.1, 5.2, 5.3, 5.4_

- [x] 1.2 TypeScript設定の更新
  - tsconfig.jsonにWeb Worker用の型定義を追加する
  - Worker内で使用するAPIの型安全性を確保する
  - _Requirements: 2.3_

- [x] 1.3 Cloudflare環境の型定義を追加
  - Worker環境でKV Namespaceにアクセスするための型定義を追加する
  - Cloudflare.EnvインターフェースにVIEWER_KVを追加する
  - _Requirements: 1.2, 4.1_

- [x] 2. データ管理層の実装
- [x] 2.1 閲覧者情報を管理するサービスの実装
  - Cloudflare KVに対する閲覧者操作を抽象化するサービスを作成する
  - 閲覧者登録機能を実装し、TTL付きでKVに保存する
  - 閲覧者情報の更新機能を実装し、TTLをリセットする
  - 閲覧者情報の削除機能を実装する
  - アクティブな閲覧者の存在確認機能を実装する
  - エラーハンドリングをneverthrowのResult型で実装する
  - _Requirements: 1.2, 2.2, 3.2, 4.1, 5.1, 5.2, 5.6_

- [x] 3. APIエンドポイントの実装
- [x] 3.1 閲覧者登録とheartbeat用のAPIエンドポイントを実装
  - POST /api/viewerエンドポイントを作成する
  - リクエストボディからsessionIdを取得し、バリデーションを行う
  - ViewerServiceを使用して閲覧者情報をKVに保存または更新する
  - 成功時はHTTP 200を返却し、エラー時は適切なエラーレスポンスを返却する
  - Cloudflare環境からKV Namespaceを取得する処理を実装する
  - エラーハンドリングとログ記録を実装する
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 2.1, 2.2_

- [x] 4. フロントエンドの閲覧者管理機能の実装
- [x] 4.1 Web Workerでheartbeatを送信する機能を実装
  - Worker起動時に一意のsessionIdを自動生成する
  - Worker起動時に即座に1回閲覧者登録リクエストを送信する
  - 30秒間隔でheartbeatリクエストを自動送信する
  - エラーが発生した場合は無視し、次のheartbeatサイクルで再試行する
  - Worker終了時にタイマーをクリーンアップする
  - _Requirements: 1.1, 2.1, 2.3, 2.4, 2.5, 3.2_

- [x] 4.2 ページロード時にWorkerを起動するhookを実装
  - クライアントコンポーネントでWorkerを起動するhookを作成する
  - ページ離脱時にWorkerを終了する処理を実装する
  - ページ遷移イベントを監視し、確実にWorkerをクリーンアップする
  - _Requirements: 1.1, 3.1, 3.2, 3.3_

- [x] 4.3 レイアウトに閲覧者管理機能を統合
  - Server Componentのレイアウトでhookを使用できない場合の対応を実装する
  - クライアントコンポーネントラッパーを作成し、レイアウトに追加する
  - アプリケーション全体で閲覧者管理が有効になることを確認する
  - _Requirements: 1.1, 2.1, 3.1_

- [x] 5. Cron処理への閲覧者チェック機能の統合
- [x] 5.1 Cron実行時に閲覧者存在確認を追加
  - Cron処理の最初にアクティブな閲覧者が存在するかをチェックする
  - KV Namespaceが設定されていない場合は警告を出して生成処理を続行する
  - 閲覧者が存在しない場合は早期リターンで生成処理をスキップする
  - 閲覧者が存在する場合は通常の生成処理フローを実行する
  - エラーが発生しても生成処理は続行する（フォールバック）
  - スキップ時のログ記録を実装する
  - _Requirements: 4.1, 4.2, 4.3, 6.1, 6.2, 6.3_

- [ ] 6. 統合テストと動作確認
- [ ] 6.1 閲覧者登録とheartbeatの動作確認
  - ページロード時に閲覧者登録が正常に動作することを確認する
  - 30秒間隔でheartbeatが送信されることを確認する
  - KVに閲覧者情報が正しく保存され、TTLが設定されることを確認する
  - _Requirements: 1.1, 1.2, 2.1, 2.2, 5.1, 5.2_

- [ ] 6.2 ページ離脱時の動作確認
  - ページを閉じた際にWorkerが正常に終了することを確認する
  - Worker終了後にheartbeatが停止することを確認する
  - TTLによる自動削除が正常に動作することを確認する
  - _Requirements: 3.1, 3.2, 3.3, 5.5_

- [ ] 6.3 Cron処理での閲覧者チェックの動作確認
  - 閲覧者が存在する場合に生成処理が実行されることを確認する
  - 閲覧者が存在しない場合に生成処理がスキップされることを確認する
  - スキップ時のログが正しく記録されることを確認する
  - KV Namespaceが設定されていない場合のフォールバック動作を確認する
  - _Requirements: 4.1, 4.2, 4.3, 6.1, 6.2_
