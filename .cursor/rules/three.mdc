---
description:
globs: src/**/*.tsx
alwaysApply: false
---

# React Three Fiber Rules (TSX)

最重要だけを短い命令に。R3F利用時は本リストを厳守。

## 1. Canvas とレンダリング

- Canvasは既定で省電力化: `<Canvas frameloop="demand" dpr={[1,1.5]}>`
- 常時アニメが必要な時のみ `frameloop="always"` を使う
- 重い内容は必ず `<Suspense fallback={null}>` で包む
- Dev時のみ `<Perf />`, `<AdaptiveDpr />`, `<AdaptiveEvents />` を使い、Prodではオフ

## 2. invalidate とコントロール

- Dreiのコントロールを優先採用（自動で `invalidate` 連携）
- React外でthreeオブジェクトを直接変更したら `invalidate()` を必ず呼ぶ
- demandモードで同期アニメ開始時は「先に `invalidate()`、次フレームで開始」

## 3. オブジェクトの再利用とプロップ

- `geometry/material/texture` は共有・`useMemo` で再生成禁止
- `position/rotation/color` 等の配列・オブジェクトは `useMemo` で安定参照に
- リスト要素の `key` は安定化（indexキー禁止。順序変動で破綻）
- 頻繁な差し替えはリーク監視。不要資源は適切に破棄

## 4. ローディングとアセット

- `useLoader` を使いキャッシュ前提で読み込む
- GLTFはDraco/Meshopt圧縮、テクスチャはKTX2等で圧縮
- 重い3Dコンポーネントは `React.lazy` + `Suspense` で遅延読み込み

## 5. 大量オブジェクト最適化

- 同形状多数は `InstancedMesh` または Dreiの `<Instances />` を使う
- 遠景はLODや簡略メッシュを使い、不要影は切る

## 6. ライト/シャドウ/ポスト

- ライトは最小限（1–2灯＋ベイク優先）
- `castShadow/receiveShadow` は必要最小、影解像度は小さく
- ポストエフェクトは控えめに。低性能時は無効化

## 7. 状態と並行処理

- 再レンダを絞る: 参照はref、フレーム処理は `useFrame` に寄せる
- UI側の重い更新は `useTransition` で遅延・優先度制御
- 全ツリーに波及するprops変更を避ける

## 8. useFrame とアニメ

- `useFrame` 内で割り当て禁止（new生成・配列作成NG）
- demandモードでの動作は「必要時だけ `invalidate()`」で描画
- アイドル時は更新停止。条件付きでフレーム処理を実行

## 9. イベントと回帰制御

- 高頻度イベントは必ずデバウンス/スロットル
- 重処理中は `regress()` で一時的に品質低下→負荷回復で戻す
- `<AdaptiveDpr />` と組み合わせて動的に解像度を下げる

## 10. Next.js 連携

- CanvasやR3F依存は `dynamic(() => import(...), { ssr: false })`
- 3D関連はTSXを小さく分割し、共通ロジックはフック/モジュールへ集約

## 11. デバッグ/補助

- 補助系（axes/grid/helper/Perf）はDev限定。`useFrame` の `console.log` 禁止

## 参考

- React Fiber 概説・最適化の要点（優先度/分割/並行機能）  
  https://blog.openreplay.com/ja/react-fiber-%E7%90%86%E8%A7%A3-%E3%83%AC%E3%83%B3%E3%83%80%E3%83%AA%E3%83%B3%E3%82%B0%E6%80%A7%E8%83%BD%E5%90%91%E4%B8%8A/
- R3F: Scaling performance（demand描画/invalidates/インスタンシング/AdaptiveDpr等）  
  https://r3f.docs.pmnd.rs/advanced/scaling-performance
- R3F: Performance pitfalls（アンチパターン回避集）  
  https://r3f.docs.pmnd.rs/advanced/pitfalls
